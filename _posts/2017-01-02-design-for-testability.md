---
layout: post
link: https://blog.nelhage.com/2016/03/design-for-testability/
title_cn: 一切为了测试
translate_time: 40
comments: true
tags:
- 单元测试
---

当一个程序员开始设计一个新的软件的时候，他总会面对一系列选择来把代码组织起来。比如“哪些应该是核心的类？”，以及“这些代码如何发生关系？”在这篇文章中，我会谈一些非常有用的极具启发性的设计方法，这些方法对于如何优化代码结构以便使测试更加方便具有决定性作用。

当你在写新代码的时候，你会设计代码的结构和它与系统其它代码之间的关系。此时你需要自问：“我将怎么测试这些新代码？如果我对系统其它部分可以做出最小程度的假设，我该怎么写这些代码以便确保它们的正确性？”如果你无法回答这两个问题，那么请重新设计抽象化的部分（abstractions）和接口（interfaces）。

按此问题设计代码有助于获得以下两个好处：

## 更好的测试性

显而易见，如果你抱着“写出有助于良好测试的代码”为目标而写，那么你极有可能写出具有良好测试性的代码。

首先我想强调一下具有良好测试性代码的优势：验证代码的过程非常简单——只需要运行测试。再也不用搭建复杂的开发环境或者手动测试系统的某个部分；只需要运行`make test`，一切迎刃而解。

在大型成熟的软件系统中，修改程序最困难的部分其实不是修改本身，而是确保该项修改不会搞乱系统的其它重要部分。测试能够提供一种快速的方法来确保生产环境的稳定性。

其次，为了能理解良好测试性的优点，你需要至少能够运行能够覆盖到修改的代码部分的测试的子集。这样的测试非常迅速，并且可以顾全快速开发的需要。在这种情况下，单元测试非常重要。诚然，对于一些诸如“单元”，“功能性”和“整合”这样的概念，不同的程序员有完全不同的看法。我刚才谈到的单元测试是指那些有着最小的依赖的模块或代码组织。另外你也需要运行一些整合测试。这些测试能够从头到尾过一遍程序，以便确保模块之间的交互正常运转。

依靠单元测试有如下优点：

- 速度快：单元测试代码短小，运行它们要比运行整个程序更快速
- 可扩展：对于大多数具有单元测试的程序来说，测试速度与程序大小之间应有线性增长关系。对于功能性测试（functional tests）来说，由于每个模块之间相互依赖，这种关系更接近于平方。
- 因为单元测试与代码块之间的对应关系，对于某此修改来说，程序员可以更快找到测试代码进行测试

良好的单元测试不是凭空发生的，它们的存在强烈依赖于对于“单元”的良好定义。一个单元应该是一组有着精确功能的和良好接口的代码，程序员可根据接口来编写测试文件。

## 更好的代码

写代码时时刻谨记“测试性”的好处之二是你会得到更好的代码。以下是一些方便测试的代码应该具有的特点：

### 大量使用不可变（immutable）数据类型的纯函数

使用不可变数据的纯函数使测试非常方便：只要编写一些输入输出的结果就可以了。

### 有着良好定义接口的小型模块

如果代码短小精悍，有良好定义的接口，我们可以直接写一些黑箱测试。它们不必担心模块内部构造就可以测试模块的接口。

### IO和逻辑分离

IO比纯代码组织更难以测试。因此具有良好测试性的系统会把IO部分单独隔离开，以便使其单独测试。

### 清晰的依赖的声明

总的来说，可测试的代码把依赖作为外部参数，而不是把它们当作环境的一部分。

## 结论

对于复杂的软件系统来说，能够快速提交修改并能运行高质量的测试的能力是非常重要的。良好测试性来源于良好的设计。当你在写一个软件的时候，总是扪心自问：“我该如何测试程序的正确性？”并且身体力行。作为回报，你将会写出一个具有良好的结构的系统。