---
layout: post
link: http://code.flickr.net/2017/01/05/a-year-without-a-byte/
title_cn: 年年“无”余
translate_time: 75
comments: true
author: Archie Russell
organization: Flickr
tags:
- flickr
- compression
---

运营Flickr图片网站最大的开支之一是存储费用。在2016年初，我们开始了一项全新的挑战：整整一年内不使用新的硬件存储空间。我们在上一年里使用了诸多技术来削减存储成本：使用[对象存储系统(COS)](https://yahooeng.tumblr.com/post/116391291701/yahoo-cloud-object-store-object-storage-at)，使用基于GPU的[动态压缩](http://code.flickr.net/2015/06/25/real-time-resizing-of-flickr-images-using-gpus/)和[感知压缩](http://code.flickr.net/2015/09/25/perceptual-image-compression-at-flickr/)等。这些技术让我们完成了挑战。

## 背景介绍

数学计算表明，存储成本并不是小问题。通常Flickr的用户在高峰期的一天内会上传大约两千五百万张照片。这些照片平均每张3.25MB大小，一共要80TB的空间。如果食用S3这样的云存储服务，这一天的数据将会造成一年三万美元的开支，并且今后每一天都会花钱。

另外，对于一个拥有超过两亿活跃用户的服务来说，每一千张照片每年会造成2.5亿美元（每个用户每年1.25美元）的成本，再加上网络服务和其他开支。随着新用户的注册和现有用户持续使用服务，这个增长率会越来越快。幸好我们的每个大型服务的成本并不基于S3。

![存储成本和图片尺寸](https://c1.staticflickr.com/1/445/32109964665_f465976673_o.png)

> 上图表明数据的成本减少了，但是iPhone上传的照片的数据显著增加，造成每张图片的实际存储成本未发生显著变化

存储成本实际上随着科技的进步是保持下降趋势的。举个栗子，S3的存储费用在2009年时为每$0.15/GB/月，到2014年时这个数字已经降到$0.03。并且云存储服务商们提供了一些低成本方案，可以让一些不常被访问的数据的存储成本进一步降低。NAS提供商本也有一些降价方案。

然而，这些降低成本的努力被另外一些因素抵消了。近年来每一代新的iPhone都会配备更高像素的摄像头，或者添加一些类似短视频的照片格式(Live photos)，这些都会让每张照片的尺寸增大，导致总体来看每张图片的存储成本实际上变化不大，即使如此，iPhone照出来的照片尺寸还不算最大的。

为解决此问题，图片存储服务商给用户提供更多的选择：低像素图片压缩、整合广告服务、售卖打印照片服务、捆绑其他商品等等。

另外还有一些技术上的方法来控制成本。我们选了我们正在使用的三种主要办法加以说明：调整我们的存储系统的阈值，拓展现有方案和采取无损JPG压缩。

## 调整存储阈值

这个方案需要从存储系统的细节角度考虑。我们发现以前的存储系统设定基于这样的假设：高量写入和删除不会持续存在。我们的存储系统相当静态。用户上传完图片后很少会删除或者修改它们。因此，系统的5%的空间用来保留给系统快照，用来恢复误删的情况，另有8.5%是空闲空间。加起来一共有13%左右的存储系统处于未使用状态。Trade lore称，为了避免性能下降，磁盘应该保有10%的空闲空间。但我们发现5%已足够。所以我们把这两个避险空间合并一起，只需要简单地修改一下系统设置，就省出了8.5%的空间。

![](https://c1.staticflickr.com/1/267/31961928142_a5f68d8501_o.png)

## 拓展现有方案

我们在以前的文章中介绍了一些动态生成缩略图和感知压缩的技术。把这两个方案结合起来我们可以把缩略图存储空间削减到原来的65%。因为修改很久以前的图片的风险很高，我们并没有把这两项技术应用于2014年以前上传的图片。

由于担心之后的动态生成缩略图可能会对我们的更改图片尺寸的程序造成较大负担，我们也只是把技术应用于即将被删除的没那么重要的图片上去。通过这种方法，我们只用四个GPU就可以搞定全部的调整尺寸的工作。这个进程给存储系统带来较大负载，为了减少对系统的影响，我们在不同的存储空间随机运行这个方案。整个进程一共花了四个月，成果比调整存储阈值的方法还要明显。

![](https://c1.staticflickr.com/1/315/31269155834_a74f75a611_o.png)

## 无损JPG压缩

Flickr不会破坏用户上传的图片的完整性，这让削减存储成本的难度极大增加，但是仍然有很多无损压缩JPG图片的技术。其中两个比较著名的是Dropbox的[PackJPG](http://www.elektronik.htw-aalen.de/packjpg/)和[Lepton](https://blogs.dropbox.com/tech/2016/07/lepton-image-compression-saving-22-losslessly-from-images-at-15mbs)。这些工具通过把JPG文件解码，然后小心使用更有效的方法来重新压缩，通常能把JPG尺寸压缩为原来的22%左右。对于Flickr来说，这是一个很大的数字。它的缺点是重新压缩需要大量CPU计算。PackJPG在单核CPU上的压缩速度是2MB/秒，压缩1PB的图片要用十五个核心年(core-year)。Lepton使用多核，速度为15MB/秒，比PackJPG快得多，但就CPU时间来说两者差不多。

这个计算能力的限制使需求更为复杂。如果我们把Flickr上所有的图片全都重新压缩，我们可能需要数千个CPU来应对解压缩的需求。我们曾考虑给这些压缩过的图片添加一些访问限制，比如要求用户登录才能看到原始图片等，但是最终我们发现如果我们只重新压缩那些私有图片的话，解压缩的频率就会大大减小。

使用无损压缩来过一遍用户的原始图片是一个高风险的方法。重建缩略图很容易，但一旦原始图片被损坏就很难修复了。我们使用了一个“压缩-解压缩验证策略”。即在删除原始图片前，每一张重新压缩过的图片都会跟原始图片比较。

## 其他备选方案

在现有存储模型中，我们对每一张图片都有原始图片和缩略图，每张图都被存储在两个数据中心中。这个模型的预设条件是任何时间打开任意图片都要非常快。但是很多私人图片可能好几个月都没有被访问过。我们其实可以把这些图片锁住，把它们的缩略图删除掉，等到用户访问的时候再重新渲染缩略图。这个“解冻”过程对于每一个账户只需要花费30秒钟。另外，对于私有图片，我们也可以把每张缩略图存储一次，而把压缩的缩略图放在另外一个数据中心，再在需要的时候解压缩。

我们可能并不需要每张图片都有两个备份。我们曾考虑如果把其中一个备份放在一个较慢但是不常用的基于磁带的存储系统，而把另外一个备份放在磁盘中。这样的后果是如果发生宕机事件，Flickr的服务会变得不可靠。不过因为这些图片属于休眠用户，所以影响不会很大。唯一需要注意的是磁带存储的速度会非常慢。这种方案可以把存储空间的使用下降25%。

我们还考虑过减少重复图片。我们发现图片的重复率大约为3%。用户在他们的设备上有大量重复图片，但是我们的上传工具可以发现并剔除它们。我们还考虑过使用另外一种格式来存储缩略图。WebP格式比JPG压缩率更高。[BPG](http://bellard.org/bpg/)项目提出了一种基于H.265的更小的图片格式，不过有各种问题。

还有一些给视频的优化方案。但尽管Flickr主要是图片服务，但是视频远比图片的尺寸要大，会消耗更多的存储空间。

## 结论

![](https://c1.staticflickr.com/1/751/32071867876_1cd6466b9a_o.png)

自2013年以来我们已经把存储空间优化到原来的50%多。我们2016年的努力让我们整整一年没有使用任何新的存储空间，而且我们还有很多没使用的方案。